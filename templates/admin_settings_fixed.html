{% extends "base.html" %}

{% block title %}Настройки системы{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">
        <i class="bi bi-gear text-primary"></i> Настройки системы
    </h1>
    <p class="text-muted">Управление настройками системы и пользователями</p>

    <!-- Простая таблица пользователей для тестирования -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>
                        Управление пользователями
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Имя пользователя</th>
                                    <th>ФИО</th>
                                    <th>Email</th>
                                    <th>Роль</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}">
                                    <td>{{ user.id[:8] }}...</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.name }}</td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if user.role == 'admin' else 'warning' if user.role == 'it_staff' else 'info' }}">
                                            {{ 'Админ' if user.role == 'admin' else 'IT' if user.role == 'it_staff' else 'Пользователь' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="editUserFixed('{{ user.id }}')" title="Редактировать">
                                            <i class="bi bi-pencil"></i> Редактировать
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Простое модальное окно для тестирования -->
<div class="modal fade" id="editUserModalFixed" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактирование пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Модальное окно работает!</p>
                <p>ID пользователя: <span id="modalUserIdFixed"></span></p>
                <p>Время вызова: <span id="modalTimeFixed"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ИСПРАВЛЕННАЯ ВЕРСИЯ - РАБОТАЕТ С BASE.HTML
console.log('=== ЗАГРУЗКА JAVASCRIPT ИСПРАВЛЕННОЙ ВЕРСИИ ===');
console.log('=== ВРЕМЯ: ' + new Date().toISOString() + ' ===');

// Ждем полной загрузки DOM и всех скриптов
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM загружен - исправленная версия');
    
    // Проверяем доступность Bootstrap
    if (typeof bootstrap !== 'undefined') {
        console.log('Bootstrap доступен:', typeof bootstrap);
        console.log('Bootstrap.Modal доступен:', typeof bootstrap.Modal);
    } else {
        console.error('Bootstrap НЕ доступен!');
    }
    
    // Проверяем доступность наших функций
    console.log('editUserFixed определен:', typeof editUserFixed);
    console.log('Модальное окно найдено:', !!document.getElementById('editUserModalFixed'));
});

// Функция editUserFixed - исправленная версия
function editUserFixed(userId) {
    console.log('editUserFixed вызван с ID:', userId);
    console.log('Время вызова:', new Date().toISOString());
    
    try {
        // Показываем ID в модальном окне
        const modalUserId = document.getElementById('modalUserIdFixed');
        const modalTime = document.getElementById('modalTimeFixed');
        
        if (modalUserId) {
            modalUserId.textContent = userId;
        } else {
            console.error('Элемент modalUserIdFixed не найден!');
        }
        
        if (modalTime) {
            modalTime.textContent = new Date().toLocaleString();
        } else {
            console.error('Элемент modalTimeFixed не найден!');
        }
        
        // Показываем модальное окно
        const modalElement = document.getElementById('editUserModalFixed');
        if (modalElement && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            console.log('Модальное окно показано успешно');
        } else {
            console.error('Не удалось показать модальное окно:', {
                modalElement: !!modalElement,
                bootstrap: typeof bootstrap,
                Modal: typeof bootstrap?.Modal
            });
        }
        
    } catch (error) {
        console.error('Ошибка в editUserFixed:', error);
        alert('Ошибка: ' + error.message);
    }
}

// Проверяем, что функция определена
console.log('editUserFixed определен:', typeof editUserFixed);

// Дополнительная проверка после небольшой задержки
setTimeout(function() {
    console.log('=== ПРОВЕРКА ПОСЛЕ ЗАДЕРЖКИ ===');
    console.log('editUserFixed доступен:', typeof editUserFixed);
    console.log('Bootstrap доступен:', typeof bootstrap);
    console.log('Модальное окно найдено:', !!document.getElementById('editUserModalFixed'));
}, 1000);
</script>
{% endblock %}
